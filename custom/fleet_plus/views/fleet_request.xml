<odoo>
    <record id="fleet_request_sequence" model="ir.sequence">
        <field name="name">FleetRequest</field>
        <field name="code">fleet.request</field>
        <field name="prefix">DM/%(y)s/%(month)s/</field>
        <field name="padding">4</field>
    </record>

    <record id="fleet_request_view_form" model="ir.ui.view">
        <field name="name">fleet.request.view.form</field>
        <field name="model">fleet.request</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button
                        name="button_draft"
                        type="object"
                        string="Remettre en brouillon"
                        class="btn-secondary"
                        invisible="state not in ['validated', 'rejected']"
                    />
                    <button
                        name="button_validated"
                        type="object"
                        string="Valider"
                        invisible="state != 'draft'"
                        class="btn-primary"
                    />
                    <field
                        name="state"
                        widget="statusbar"
                        statusbar_visible="draft,validated,approved,in_progress,done"
                    />
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Rejetée" bg_color="text-bg-danger" invisible="state != 'rejected'"/>
                    <widget name="web_ribbon" title="Traitée" bg_color="text-bg-success" invisible="state != 'done'"/>
                    <widget name="web_ribbon" title="Close" bg_color="text-bg-success" invisible="state != 'closed'"/>
                    
                    <label for="name" class="oe_inline"/>
                    <h1>
                        <field name="name" readonly="1" class="oe_inline"/>
                    </h1>
                    <group>
                        <group>
                            <field name="is_line_ids_set" invisible="1"/>
                            <field name="site_id" 
                                   readonly="state != 'draft' or is_line_ids_set" 
                                   options="{'no_create': True, 'no_open': True}" required="1"/>
                            
                            <field name="type" widget="radio" options="{'horizontal': true}" 
                                   readonly="state != 'draft' or is_line_ids_set"/>
                        </group>
                        <group>
                            <field name="requested_by" options="{'no_create': True, 'no_open': True}" readonly="1" force_save="1"/>
                            <field name="requested_on" readonly="1" force_save="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Lignes">
                            <field name="equipment_ids" invisible="1"/>
                            <field name="small_equipment_ids" invisible="1"/>
                            
                            <field name="line_ids" 
                                   readonly="state != 'draft' or not site_id" 
                                   options="{'no_create': True, 'no_open': True}">
                                <list editable="bottom" decoration-danger="state == 'rejected'">
                                    <field name="equipment_id" 
                                           domain="[('id', 'in', parent.equipment_ids)]" 
                                           column_invisible="parent.type != 'equipment'" 
                                           required="parent.type == 'equipment'"/>
                                    
                                    <field name="small_equipment_id" 
                                           domain="[('id', 'in', parent.small_equipment_ids)]" 
                                           column_invisible="parent.type != 'small'" 
                                           required="parent.type == 'small'"/>
                                    
                                    <field name="state"
                                           widget="badge"
                                           column_invisible="parent.state in ['draft', 'validated']"
                                           decoration-info="state == 'draft'"
                                           decoration-warning="state in ['validated', 'approved', 'in_progress']" 
                                           decoration-success="state in ['done', 'closed']" 
                                           decoration-danger="state == 'rejected'"
                                    />
                                </list>
                            </field>
                        </page>
                        <page string="Historique">
                            <div class="oe_chatter">
                                <field name="message_follower_ids"/>
                                <field name="activity_ids"/>
                                <field name="message_ids" options="{'post_refresh': 'recipients'}"/>
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="fleet_request_view_tree" model="ir.ui.view">
        <field name="name">fleet.request.view.list</field>
        <field name="model">fleet.request</field>
        <field name="arch" type="xml">
            <list export_xlsx="0" decoration-info="state == 'draft'" decoration-danger="state == 'rejected'">
                <field name="name"/>
                <field name="requested_by"/>
                <field name="requested_on"/>
                <field name="site_id"/>
                <field 
                    name="state" 
                    widget="badge"
                    decoration-info="state == 'draft'"
                    decoration-warning="state in ['validated', 'approved', 'in_progress']"
                    decoration-success="state in ['done', 'closed']"
                    decoration-danger="state == 'rejected'"/>
            </list>
        </field>
    </record>

    <record id="fleet_request_action" model="ir.actions.act_window">
        <field name="name">Demandes</field>
        <field name="res_model">fleet.request</field>
        <field name="view_mode">list,form</field>
    </record>
</odoo>